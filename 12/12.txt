Практикалық жұмыс 12. Компьютерлік желілерде стеганография әдістерін қолдану және қауіпсіздік шаралары

Мақсаты
Желілік ортада қолданылатын стеганографияның негізгі түрлерімен танысу.
Қауіптерді түсіну: қандай желілік арналар (DNS, HTTP, ICMP, TCP опциялары, VoIP) стего-арнаға айналуы мүмкін екенін анықтау.
Қазіргі заманғы детекция және қорғау тәсілдерін практикада қолдану (tshark/Zeek/Suricata/Scapy/pyshark арқылы анализ).
Желілік әкімші/құпиялылық маманы ретінде қауіптің қалай пайда болатынын анықтап, оны жою/азайту бойынша саясат пен техникалық шаралар әзірлеу.

Теориялық бөлім — желі деңгейіндегі стеганография: әдістер мен қатерлер
1. Желідегі негізгі стеганография арналары
DNS tunneling / DNS covert channels — хабарламаларды DNS сұрауларының субдомейндеріне бөліп жазып жібереді (мыс., asdasdasd.secret.example.com). Қолданылуы — бақылаудан өту үшін.
HTTP header / URI fields — HTTP сұрауларындағы Cookie, User-Agent, Referer, URL path ішіндегі кодталған деректер.
ICMP / Ping — ICMP payload-ына дерек жазу (қолдану: кейде мониторинг пен диагностика шеңберінде рұқсатты болады).
TCP options / sequence numbers / timing channels — TCP пакет құрылымындағы опциялар, seq/ack аздаған биттерін қолдану немесе пакет арасындағы уақыт интервалдарын (timing covert channels) хабар тасымалдауға қолдану.
DNS TXT / TXT-like — TXT жазбалары арқылы үлкен көлемдегі деректерді беру.
VoIP (RTP) / video streams — аудио/бейне толықтырмаларға (LSB, watermarking) орналастыру арқылы.
HTTP(S) over CDNs / Cloud storage — файлдардың метадеректеріне немесе нақты файлдың бөліктеріне жасыру; HTTPS болған жағдайда DPI-дан өту оңайырақ болуы мүмкін.
2. Қауіп деңгейі мен қолдану себептері
Құпия деректерді сыртқа шығару (data exfiltration).
Командалық-басқару каналдары (C2) — зияткерлік шабуылдарда.
Бақылаудан құтылу (evading detection): SSL/TLS, CDN трафигі, жиі қолданылатын протоколдар арқылы жүргізу.
3. Негізгі анықтау (детекция) тәсілдері
Статистикалық талдау: сұраулар жиілігі, сұрау ұзындығы, субдомен ұзындығының энтропиясы.
Ережелік детекция: IDS/IPS ережелері (Suricata/Snort) — DNS tunneling-ге қарсы деңгейлік сигнатуралар.
Аномалияны анықтау (ML): трафиктің қалыпты профилінен ауытқулар (flow-based features: пакеттер саны, орташа payload ұзындығы, энтропия, inter-arrival times).
Контенттік тексеріс (DPI): HTTP сұрауларындағы күмәнді header/URI/POST денесін талдау (HTTPS шифрланғандықтан, бұл HTTPS-ты MITM арқылы ғана мүмкін).
Агрегация және correlation: бірнеше уақытша терезеде DNS сұраулардың үздіксіз кішігірім сұраулары — exfiltration индикаторы.

Қадамдық нұсқаулық — анықтау және қорғау (әдетте әкімшілер мен қауіпсіздік инженерлері үшін)
Төмендегі қадамдар — желідегі жасырын арналарды табуға және оларды азайтуға арналған. Қайта-қайта «қандай да бір арнаға хабар жазу» көрсетпейміз (қолданушының зиянкестерге көмектесу қаупі болмас үшін). Барлық командалар қорғаныс/талдау мақсатында пcap-тар және өз тесттік ортада пайдалану үшін берілген.
Құралдар (өте пайдалы жиынтық)
tcpdump / tshark — пакеттерді ұстап алу және жылдам талдау.
Zeek (Bro) — желі телеметриясын байыту: DNS, HTTP, TLS, Conn логтар.
Suricata / Snort — IDS/IPS ережелері арқылы детекция.
Scapy / pyshark — Python-да интерактивті талдау.
ELK / Splunk / Graylog — логтарды жинау және іздеу.
DNS Firewall (Pi-hole, Infoblox, коммерциялық шешімдер) — күмәнді домендерді блоктау.

Қадам A — пакеттерді жинау (pcap жасау)
# интерфейсті өзіңіздің жүйеңізге ауыстырыңыз (eth0, enp0s3)
sudo tshark -i eth0 -w capture.pcap -a duration:300
# немесе tcpdump
sudo tcpdump -i eth0 -s 0 -w capture.pcap
Қадам B — Zeek арқылы бастапқы талдау (DNS/HTTP/Conn)
# Zeek орнатылған деп есептейік
zeek -r capture.pcap
# Осыдан кейін conn.log, dns.log, http.log пайда болады
# Мыс., dns.log ішінен ұзындығы үлкен сұрауларды табу:
awk -F'\t' 'length($8) > 50 {print $0}' dns.log
dns.log-тегі 8-баған — сұрау атауы (query name). Ұзын, кездейсоқ субдомендер DNS tunneling индикаторы болуы мүмкін.
Қадам C — Tshark / tshark-based сұрау (DNS)
# DNS сұрауларын шығару
tshark -r capture.pcap -Y "dns.qry.name" -T fields -e frame.time -e ip.src -e dns.qry.name
Осының нәтижесін қарап, жиі қайталанатын кішігірім сұрауларды іздеңіз.
Қадам D — payload энтропиясын есептеу (Python + Scapy)
Желідегі тексеріс үшін «payload энтропиясы» — жақсы индикатор. Төменде pcap файлдағы TCP/UDP payload-тарының энтропиясын есептейтін қарапайым мысал:
# файл: entropy_analyze.py
from scapy.all import rdpcap
import math
def entropy(data):
    if not data:
        return 0.0
    counts = {}
    for b in data:
        counts[b] = counts.get(b,0)+1
    ent = 0.0
    l = len(data)
    for v in counts.values():
        p = v / l
        ent -= p * math.log2(p)
    return ent

pkts = rdpcap('capture.pcap')
for p in pkts:
    if p.haslayer('Raw'):
        data = bytes(p['Raw'].load)
        e = entropy(data)
        if e > 6.5:  # жоғары энтропия шекті мәні (эксперимент)
            print(p.summary(), "entropy:", round(e,2))
Түсініктеме: энтропия жоғары болса (шамамен >6.5 — тәжірбиелік шама), дерек «кодталған/шитьрланған/рандомизацияланған» болуы мүмкін, сондықтан тексеруді қажет етеді.
Қадам E — DNS сұрауларындағы аномалияны Zeek/SQL-де табу
Zeek-тан алынған dns.log-ты ELK/Splunk-қа жүктеп, келесі есептерді жасаңыз:
IP бойынша бір тәулікте сұраулар саны (DNS volume).
Бір сұрау үшін орташа субдомен ұзындығы.
Бір клиенттен келген сұраулардың субдомендерінің энтропиясының өзгерісі.
Қадам F — Suricata / Snort арқылы ереже орнату (мысал: DNS tunneling сигнатурасы)
Suricata-да дайын ережелер бар (Emerging Threats). Оларды қосып, хабарландыруларды қарап отырыңыз.
Қолмен қарапайым ереже мысалы (қатаң емес, мысал): alert udp any any -> any 53 (msg:"DNS suspicious subdomain length"; dns_query; content:".example.com"; pcre:"/.{50,}\.example\.com$/"; sid:1000001;)
(Ескерту: нақты өндірісте pcre ережелері өнімділікке әсер етуі мүмкін; дұрыс конфигурация қажет.)
Қадам G — HTTPS / TLS трафигін бақылау (SNI/JA3)
HTTPS шифрланған болғанда да SNI (Server Name Indication) алаңын бақылап, күдікті домендерді табуға болады. JA3 отпечатки TLS қолданысын талдауға көмектеседі (кейде C2 серверлерінің JA3-сы белгілі болады). Zeek TLS логтары осы үшін пайдалы.
Қадам H — Egress бақылау және деректер шығу саясаты
Egress (шығыс) трафикті тексеріп, қолданушыға шектелген домендерге ғана рұқсат беру.
DNS сұрауларын корпоративтік DNS арқылы бағыттау, сыртқы DNS-ті (8.8.8.8 т.с.с.) блоктау.
Қолданушыларға VPN немесе HTTPS прокси арқылы арналған ереже орнатыңыз, бірақ бақылаусыз проксиді белгілеңіз (олар да аутентификациясыз дерек шығару арнасы болуы мүмкін).

Практикада мысалдар (қорғаныс бағытында)
Мысал 1 — DNS tunneling анықтау (жедел тексеріс)
tshark -r capture.pcap -Y "dns.qry.name" -T fields -e ip.src -e dns.qry.name арқылы клиенттің DNS сұрауларын экспорттау.
Субдомен ұзындықтарын есептеп, орташа > 50 таңба болса талдаңыз.
Егер сұраулар қысқа болса да тым жиі (секундтық/минуттық сұраулар көп) — тағы да күдік.
Мысал 2 — ICMP payload энтропиясы
Ping-based covert channel болуы мүмкін. tshark -r capture.pcap -Y "icmp" -T fields -e ip.src -e icmp.data шығаруды қолданып, payload энтропиясын есептеңіз. Энтропия жоғары болса — әрі қарай тексеріңіз.
Мысал 3 — HTTP header suspiciousity
Zeek-тен http.log алыңыз; User-Agent, Referer, Cookie сияқты өрістерде base64 немесе ұзын санаттарды іздеңіз.
grep -P "[A-Za-z0-9+/]{40,}=" сияқты регекс base64-қа ұқсас өрнекті табуға көмектеседі.

Студенттерге жеке практикалық тапсырма
capture.pcap файлынан барлық DNS сұрауларын шығарып, сұраулардың орташа ұзындығын есептеңіз.
Бір IP-ден бір минут ішінде жасалған DNS сұраулар санын талдаңыз; график құрыңыз.
tshark көмегімен барлық HTTP User-Agent өрістерін экспорттап, base64-қа ұқсас мәндерді табыңыз.
Zeek-пен алынған dns.log файлын оқып, 24 сағат ішіндегі ең жиі сұралатын домендерді анықтаңыз.
Scapy-мен pcap ішіндегі барлық ICMP пакеттерінің payload энтропиясын есептеп, жоғары энтропиялы пакеттерді анықтаңыз.
TLS JA3 отпечаткасын Zeek-тан шығарып, белгісіз JA3-тарды белгілеңіз.
Suricata орнатып, Emerging Threats ережелерін қосып, нақты pcap-та ескертулерді шақырыңыз.
DNS сұрауларындағы субдомендердің таңбалар жиілігін (frequency) есептеп, Shannon энтропиясын шығарыңыз.
Тесттік сценарий жасаңыз: компьютерден жиі, қысқа DNS сұрауларын жасап көріңіз және оларды Zeek арқылы анықтауды сынаңыз. (Тек өз зертханалық ортада.)
HTTP POST денесінде ұзын base64 мәндерді табатын регекске негізделген скрипт жазыңыз.
pcap-тан шығатын пакеттердің IP flow-тарын құрастырып (src,dst,srcport,dstport), орташа пакет өлшемін есептеңіз; аномалды flow-тарды табыңыз.
Egress политикасы қажет екенін дәлелдеу үшін, белгілі бір IP-ге бағытталған барлық шығыс сұраулардың күнтізбесін жасаңыз.
DNS Firewall (мысалы Pi-hole) орнатып, күмәнді домендерді блоктаңыз; бұрынғы pcap-тан қайтадан сұрауларды симуляциялап тексеріңіз.
tshark -z io,stat,1,"dns.qry.name" арқылы уақыттық статистика алыңыз және график салыңыз.
Арнайы Zeek скрипт жазып, бір клиентте бірнеше түрлі доменде бірдей base64-қа ұқсас үлгілерді табыңыз.
HTTP/HTTPS трафикте SNI өрістерінің әртүрлілігін есептеп, ерекше SNI қолданушыларды табыңыз.
DNS TXT жазбаларын жинап, олардың орташа ұзындығын салыстырыңыз; қорғау шарасын ұсыныңыз.
Pcap ішіндегі барлық TCP options-тарды шығарып, күдікті / қайталанатын паттерндерді анықтаңыз.
Пакеттер арасындағы inter-arrival time (IAT) статистикасын есептеп, timing channel мүмкіндігін іздеңіз.
Микропакеттер (tiny packets) ағымдарын анықтап, жиі кездесетін IP-дерді табыңыз.
Pyshark қолдана отырып, pcap-тан барлық DNS сұрауларына байланысты жауаптардың TTL мәндерін алып, қалыптыдан ауытқу бар-жоғын тексеріңіз.
Zeek-тен http.log және dns.log-тың корреляциясын жасап, сол бір IP-ден келген күдікті сұрауларды тізіп шығыңыз.
JA3/JA3S отпечатки бойынша білінетін C2 серверлер тізімін құрастырып,matched IP-ларды белгілеңіз.
TLS сертификат subject/issuer сәйкестігін тексеріп, күдікті сертификаттарды табыңыз.
DNS over HTTPS (DoH) трафигін қалай бақылайтыныңыз туралы саясат жазып беріңіз.
Egress мониторинг үшін қарапайым Kibana дашбордын жасаңыз (DNS сұраулар саны, орташа сұрау ұзындығы, топ-10 клиент).
Құпиялылық пен бизнес-қызметтің арасында теңгерім сақтайтын DNS саясат жазыңыз.
Инцидентте оқшаулауды қалай жүзеге асыратыныңызды (playbook) сипаттаңыз: тексеру → оқшаулау → тергеу → қалпына келтіру.
Желідегі стеганографияны анықтауға арналған октагондық (8-сатылы) чек-лист жасаңыз.
Қорытынды есеп дайындаңыз: табылған аномалиялар, қолданылған әдістер, ұсынылатын қорғау шаралары.

